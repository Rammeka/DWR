/*
	Copyright (c) 2004-2008, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo.require("dijit._editor.RichText");dojo.require("dojo.parser");dojox.off.ui.appName="Moxie";dojox.off.files.slurp();var moxie={_availableKeys:null,_documents:null,initialize:function(){var _1=dijit.byId("storageValue");if(!_1||!_1.isLoaded){dojo.connect(_1,"onLoad",this,"initialize");return;}dojo.byId("storageKey").value="";_1.setValue("Click Here to Begin Editing");var _2=dojo.byId("directory");dojo.connect(_2,"onchange",this,this.directoryChange);dojo.connect(dojo.byId("saveButton"),"onclick",this,this.save);this._createDb();this._loadKeys();this._initOfflineHandlers();this._initialized=true;},directoryChange:function(_3){var _4=_3.target.value;var _5=dojo.byId("storageKey");_5.value=_4;if(_4==""){return;}this._load(_4);},save:function(_6){_6.preventDefault();_6.stopPropagation();var _7=dojo.byId("storageKey").value;var _8=dijit.byId("storageValue");var _9=_8.getValue();if(!_7){alert("Please enter a file name");return;}if(!_9){alert("Please enter file contents");return;}this._save(_7,_9);},_save:function(_a,_b){this._printStatus("Saving '"+_a+"'...");if(dojox.off.isOnline){this._saveOnline(_a,_b);}else{this._saveOffline(_a,_b);}},_saveOnline:function(_c,_d){dojo.xhrPost({url:"/moxie/"+encodeURIComponent(_c),content:{"content":_d},error:function(_e){var _f="Unable to save file "+_c+": "+_e;if(!dojox.off.sync.actions.isReplaying){alert(_f);}else{dojox.off.sync.actions.haltReplay(_f);}},load:dojo.hitch(this,function(_10){this._printStatus("Saved '"+_c+"'");this._addKey(_c);if(!dojox.off.sync.actions.isReplaying){this._printAvailableKeys();}else{dojox.off.sync.actions.continueReplay();}})});},_saveOffline:function(key,_12){var _13={name:"save",key:key,value:_12};dojox.off.sync.actions.add(_13);if(dojox.sql("SELECT * FROM DOCUMENTS WHERE fileName = ?",key).length){dojox.sql("UPDATE DOCUMENTS SET content = ? WHERE fileName = ?",_12,key);for(var i=0;i<this._documents.length;i++){if(this._documents[i].fileName==key){this._documents[i].content=_12;break;}}}else{dojox.sql("INSERT INTO DOCUMENTS (fileName, content) VALUES (?, ?)",key,_12);this._documents.push({fileName:key,content:_12});}this._printStatus("Saved '"+key+"'");this._addKey(key);this._printAvailableKeys();},_loadKeys:function(){if(dojox.off.isOnline){this._loadKeysOnline();}else{this._loadKeysOffline();}},_loadKeysOnline:function(){var _15=this;var url="/moxie/*"+"?browserbust="+new Date().getTime()+"&proxybust="+new Date().getTime();var _17={url:url,handleAs:"javascript",headers:{"Accept":"text/javascript"},error:function(err){err=err.message||err;alert("Unable to load our list of available keys from "+"the server: "+err);},load:function(_19){_15._availableKeys=_19;_15._printAvailableKeys();}};dojo.xhrGet(_17);},_loadKeysOffline:function(){this._loadDownloadedData();this._printAvailableKeys();},_printAvailableKeys:function(){var _1a=dojo.byId("directory");_1a.innerHTML="";var _1b=document.createElement("option");_1b.appendChild(document.createTextNode(""));_1b.value="";_1a.appendChild(_1b);var _1c=this._availableKeys.slice().sort();for(var i=0;i<_1c.length;i++){var _1b=document.createElement("option");_1b.appendChild(document.createTextNode(_1c[i]));_1b.value=_1c[i];_1a.appendChild(_1b);}},_addKey:function(key){var _1f=false;for(var i=0;i<this._availableKeys.length;i++){if(this._availableKeys[i]==key){_1f=true;break;}}if(!_1f){this._availableKeys.push(key);}},_load:function(key){this._printStatus("Loading '"+key+"'...");if(dojox.off.isOnline){this._loadOnline(key);}else{this._loadOffline(key);}},_loadOnline:function(key){var _23=this;var url="/moxie/"+encodeURIComponent(key)+"?cachebust="+new Date().getTime();var _25={url:url,handleAs:"text",error:function(err){err=err.message||err;alert("The file "+key+" is not available: "+err);},load:function(_27){_23._updateEditorContents(_27);_23._printStatus("Loaded '"+key+"'");}};dojo.xhrGet(_25);},_loadOffline:function(key){var doc=null;for(var i=0;i<this._documents.length;i++){var _2b=this._documents[i];if(_2b.fileName==key){doc=_2b;break;}}this._updateEditorContents(doc.content);},_updateEditorContents:function(_2c){var _2d=dijit.byId("storageValue");_2d.setValue(_2c);},_printStatus:function(_2e){var top=dojo.byId("top");for(var i=0;i<top.childNodes.length;i++){var _31=top.childNodes[i];if(_31.nodeType==1&&_31.className=="status"){top.removeChild(_31);}}var _32=document.createElement("span");_32.className="status";_32.innerHTML=_2e;top.appendChild(_32);dojo.fadeOut({node:_32,duration:2000}).play();},_initOfflineHandlers:function(){dojo.connect(dojox.off.sync.actions,"onReplay",this,function(_33,_34){if(_33.name=="save"){this._save(_33.key,_33.value);}});dojo.connect(dojox.off.sync,"onSync",this,function(_35){if(_35=="download"){this._downloadData();}else{if(_35=="finished"){this._printAvailableKeys();}}});},_downloadData:function(){var _36=this;var _37={url:"/moxie/download?cachebust="+new Date().getTime(),handleAs:"javascript",headers:{"Accept":"text/javascript"},error:function(err){err=err.message||err;var _39="Unable to download our documents from server: "+err;dojox.off.sync.finishedDownloading(false,_39);},load:function(_3a){_36._saveDownloadedData(_3a);}};dojo.xhrGet(_37);},_saveDownloadedData:function(_3b){dojox.sql("DROP TABLE IF EXISTS DOCUMENTS");this._createDb();dojo.forEach(_3b,function(_3c){dojox.sql("INSERT INTO DOCUMENTS (fileName, content) VALUES (?, ?)",_3c.fileName,_3c.content);});this._documents=_3b;dojox.off.sync.finishedDownloading(true,null);},_loadDownloadedData:function(){this._availableKeys=[];this._documents=dojox.sql("SELECT * FROM DOCUMENTS");if(!this._documents){this._documents=[];}for(var i=0;i<this._documents.length;i++){var _3e=this._documents[i].fileName;this._availableKeys.push(_3e);}},_createDb:function(){dojox.sql("CREATE TABLE IF NOT EXISTS DOCUMENTS ("+"fileName\t\tTEXT NOT NULL PRIMARY KEY UNIQUE, "+"content\t\tTEXT NOT NULL) ");}};dojo.connect(dojox.off.ui,"onLoad",moxie,moxie.initialize);dojox.off.initialize();